
<% if current_user&.customer? %>
  <% if current_user&.paymentOn? %>
    <div class="card card-style">
      <div class="content mt-3 mb-3">
        <h3>Schedule Services</h3>
        <p class='text-justify'>
          Schedule your purchased services &amp; see the status of your pending service requests here!
        </p>
      </div>
    </div>
    <% if @invoices&.present?  %>
      <div class="card card-style">
        <div class="content mb-0">
          <div class="row mb-4">
            <div class="col-5"><h4 class="font-14 text-left"><u>Service</u></h4></div>
            <div class="col-3"><h4 class="font-14 text-justify"><u>QTY</u></h4></div>
            <div>&nbsp;</div>
          </div>
          <% @invoices.each_with_index do |h, hindx| %>
              <% h['items'].each_with_index do |itm,indx| %>
                <% if itm['price']['transform_quantity'] && !itm['price']['transform_quantity']['divide_by'].blank? %>
                  <% remainingToClaim = (itm['invoiceLine']['quantity'].to_i * itm['price']['transform_quantity']['divide_by']) - itm['invoiceLine']['metadata']['claimed'].to_i %>
                <% else %>
                  <% remainingToClaim = itm['invoiceLine']['quantity'].to_i - itm['invoiceLine']['metadata']['claimed'].to_i %>
                <% end %>


                  <% if itm['product']['type'] == 'service' && remainingToClaim > 0 %>

                    <% if !itm['invoiceLine']['metadata']['claimed'].blank? %>
                      
                      <% ((!itm['price']['transform_quantity'].blank? ? (itm['price']['transform_quantity']['divide_by'] * itm['invoiceLine']['quantity'].to_i) : 0) > itm['invoiceLine']['metadata']['claimed'].to_i) || (itm['invoiceLine']['quantity'].to_i) > (itm['invoiceLine']['metadata']['claimed'].to_i) %>

                      Claimed: <%= itm['invoiceLine']['metadata']['claimed'].to_i %>

                      <% if itm['invoiceLine']['metadata']['merchantConfirmed'] == 'true' %>
                      <span class="bg-blue2-dark float-right rounded-xs text-uppercase font-900 font-9 pr-2 pl-2 pb-0 pt-0 line-height-s mt-n1">Scheduled</span>
                      <% end %>

                      <% if  itm['invoiceLine']['metadata']['requesting'].to_i > 0 %>
                      <span class="bg-yellow1-dark float-right rounded-xs text-uppercase font-900 font-9 pr-2 pl-2 pb-0 pt-0 line-height-s mt-n1">Requested</span>
                      <% end %>


                      <div class="row mb-6">
                        <div class="col-5"><h4 class="font-14 text-left"><%= itm['product']['name'] %></h4></div>
                        <% if itm['price']['transform_quantity'] && !itm['price']['transform_quantity']['divide_by'].blank? %>
                          <!-- <div class="col-1"><h4 class="font-14 text-left"><i class="fa fa-check bg-fade-green2-dark rounded-xl color-green2-dark"></i></h4></div> -->
                          <div class="col-3"><h4 class="font-14 text-justify"><%= (itm['invoiceLine']['quantity'].to_i * itm['price']['transform_quantity']['divide_by']) - itm['invoiceLine']['metadata']['claimed'].to_i %></h4></div>
                        <% else %>
                          <!-- <div class="col-1"><h4 class="font-14 text-left"><i class="fa fa-times bg-fade-red2-dark rounded-xl color-red2-dark"></i></h4></div> -->
                          <div class="col-3"><h4 class="font-14 text-justify"><%= itm['invoiceLine']['quantity'].to_i - itm['invoiceLine']['metadata']['claimed'].to_i %></h4></div>
                        <% end %>
                        
                          <div class="col-4">
                            <button class="accordion-btn  btn btn-m btn-full bg-green1-dark text-uppercase font-900" data-toggle="collapse" data-target="#<%= itm['invoiceLine']['id'] %>" aria-expanded="false" style='margin-top:-10px;'>
                              <i class="fa fa-calendar-check"></i>
                            </button>
                          </div>

                      </div>
                      <div class="scheduleIt mt-4">
                      </div>
                    <% end %>

                    <div class="accordion" id="<%= itm['invoiceLine']['id'] %>">
                      <div id="<%= itm['invoiceLine']['id'] %>" class="collapse" data-parent="#<%= itm['invoiceLine']['id'] %>" style="">
                        <div class="text-center">

                          


                          <%= form_for :requestBooking, id: "#{h['customerStripeInfo']['name']}#{h['invoice']['id']}", url: requestBooking_path do |f| %>
                            <div class="row">
                              <div class="input-style input-style-2 mt-2 col-6">
                                Date
                                <%= f.date_select(:dateRequested, :default => { day: DateTime.now.strftime("%d") , year: DateTime.now.strftime("%Y"), month: DateTime.now.strftime("%m") }) %>

                              </div>
                              <div class="input-style input-style-2 mt-2 col-6">
                                Time
                                <%= f.time_select(:my_time, start_hour: 8, end_hour: 20,minute_step: 15, ampm: true) %>
                              </div>
                            </div>

                            <%= f.hidden_field :invoice, value: h['invoice']['id'] %>

                            <%= f.hidden_field :merchantStripeID, value: h['merchantStripeID'] %>

                            <%= f.hidden_field :serviceToBook, value: itm['invoiceLine']['invoice_item'] %>

                            <%= f.submit "Request Booking", class: "col-md-12 btn btn-m mt-2 mb-4 btn-full bg-yellow1-dark text-uppercase font-900" %>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
              <% end %>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="content mb-0 text-center">
        <h5>You have not purchased any services</h5>
      </div>
    <% end %>
  <% else %>
    <%= link_to "Setup Payment", '/profile', class: 'btn btn-full bg-yellow2-dark btn-m text-uppercase font-800 rounded-sm' %>
  <% end %>

<% end %>

<% if current_user&.manager? %>
  <div class="card card-style">
    <div class="content mt-3 mb-3">
      <h3>Schedule Services</h3>
      <p class='text-justify'>
            <% if ENV['stripeCapturePercentage'].to_i < 100 %>
              After you have accepted the date and time to complete a service, it will be removed from the list below.
            <% end %>
      </p>
    </div>
  </div>

  <!-- ANON USER CHARGEs <%= number_to_currency(@anonCharges.map{ |char| char['stripeSession']['amount_total'] }.sum * 0.01, precision: 2) %> -->

  <!-- CUSTOMER USER CHARGEs <%= number_to_currency(@customerCharges.map{|char| char['lineItems'].map{|itm| itm['amount']} }.flatten.sum * 0.01, precision: 2) %> -->

  <div class="card card-style">
    <% if @customerCharges&.present? %>
      <% @customerCharges.each do |customerCharge| %>
        <% if customerCharge['invoice']['metadata'] && customerCharge['invoice']['metadata']['confirmed'].blank? && customerCharge['invoice']['metadata']['goodOrService'] %>
          <!-- <%= customerCharge['invoice']['metadata'] %> -->
          <!-- <%= customerCharge['invoice']['id'] %> -->
          <% customerCharge['lineItems'].each do |lit| %>
            <div class="content mb-0">
              <div class="d-flex">    
                <span class="bg-red1-dark rounded-xs text-uppercase font-900 font-9 pr-2 pl-2 pb-0 pt-0 line-height-s mt-n1">Contact Customer</span>
              </div>
              <% randoUser = Stripe::Customer.retrieve(customerCharge['invoice']['customer'], {stripe_account: current_user&.stripeMerchantID}) %>

              <%= link_to randoUser['email'], "mailto:#{randoUser['email']}" %>
              <a href="#" data-menu="menu-transaction-1" class="d-flex">
                <div class="align-self-center ms-auto text-end">
                  <h2 class="font-18"><%= lit['description'] %></h2>
                </div>
              </a>
              <%= form_for :scheduleService, url: schedule_index_path(id: customerCharge['invoice']['id']) do |f| %>
                <div class="input-style has-borders no-icon mb-4">
                    
                    <label for="session<%= customerCharge['invoice']['id'] %>" class="color-highlight">Confirm &amp; schedule service with the customer</label>
                    <i class="fa fa-check disabled valid me-4 pe-3 font-12 color-green-dark"></i>
                    <i class="fa fa-check disabled invalid me-4 pe-3 font-12 color-red-dark"></i>
                </div>

                <div class="input-style has-borders no-icon mb-4">
                  <%= f.hidden_field :sessionOrInvoiceID, value: customerCharge['invoice']['id'] %>
                </div>
                <div class="input-style has-borders no-icon mb-4">
                  <%= f.submit "Service Confirmed", class: "btn bg-green1-dark text-uppercase rounded-sm font-900" %>
                </div>
              <% end %>
            </div>
            <div class="divider mt-2 mb-3"></div> 
          <% end %>
        <% end %>
      <% end %>
    <% end %>


    <% if @anonCharges&.present? %>
      <% @anonCharges.each do |charge| %>
        <% if charge['lineItems'].map{|lit| Stripe::Product.retrieve(lit['price']['product'], {stripe_account: current_user&.stripeMerchantID})['type'] == 'service' }.flatten.include?(true) %>
          <% paymentMeta = Stripe::PaymentIntent.retrieve(charge['stripeSession']['payment_intent'], {stripe_account: current_user&.stripeMerchantID}) %>
            <!-- <%= charge['stripeSession']['id'] %> -->
          <% if paymentMeta['metadata']['confirmed'].blank? %>
            <div class="content mb-0">
              <div class="d-flex">    
                <span class="bg-red1-dark rounded-xs text-uppercase font-900 font-9 pr-2 pl-2 pb-0 pt-0 line-height-s mt-n1">Contact Customer</span>
              </div>

              <%= link_to charge['stripeSession']['customer_details']['email'], "#{charge['stripeSession']['customer_details']['email']}" %>

              <% charge['lineItems'].each do |item| %>
                <!-- <%= item['id'] %> -->
                <a href="#" data-menu="menu-transaction-1" class="d-flex">
                    <h2 class="font-18"><%= item['description'] %></h2><br>
                </a>
                <!-- <div class="pull-right">
                  <h2 class="font-18 color-green2-dark"><%= number_to_currency(item['amount_total']*0.01, precision: 2) %></h2>
                </div> -->
              <% end %>

              <%= form_for :scheduleService, url: schedule_index_path(id: charge['stripeSession']['id']) do |f| %>
                <div class="input-style has-borders no-icon mb-4">
                    
                    <label for="session<%= charge['stripeSession']['id'] %>" class="color-highlight">Confirm &amp; schedule service with the customer</label>
                    <i class="fa fa-check disabled valid me-4 pe-3 font-12 color-green-dark"></i>
                    <i class="fa fa-check disabled invalid me-4 pe-3 font-12 color-red-dark"></i>
                </div>

                <div class="input-style has-borders no-icon mb-4">
                  <%= f.hidden_field :sessionOrInvoiceID, value: charge['stripeSession']['id'] %>
                </div>
                <div class="input-style has-borders no-icon mb-4">
                  <%= f.submit "Service Confirmed", class: "btn bg-green1-dark text-uppercase rounded-sm font-900" %>
                </div>
              <% end %>
            </div>
            <div class="divider mt-2 mb-3"></div> 
          <% end %>
        <% end %>


      <% end %>
    <% end %>
 

    
   </div>
<% end %>



<% if !current_user %>
  <div class="page-content header-clear-medium">

        <div class="card card-style">
            
            <div class="d-flex content mb-1">
                <!-- left side of profile -->
                <div class="flex-grow-1">
                    <h1 class="font-700">Book Now</h1>
                    <p class="mb-2">
                      All of your scheduled appointments will be posted here. Cancel an appointment anytime for free!
                    </p>
                </div>
                <!-- right side of profile. increase image width to increase column size-->
            </div>
            <!-- follow buttons-->
            <div class="content mb-0">
                <div class="row mb-0">
                    <div class="col-6">
                        <a href="<%= new_user_registration_path %>" class="btn btn-full btn-s rounded-s text-uppercase font-900 bg-green1-dark">Create Account</a>
                    </div>
                    <div class="col-6">
                        <a href="<%= new_user_session_path %>" class="btn btn-full btn-s rounded-s text-uppercase font-900 color-theme border-green1-dark">Login</a>
                    </div>
                </div>
            </div>
            
            <div class="divider mt-4 mb-0"></div>
        </div>
  </div>
<% end %>